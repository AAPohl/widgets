/**
* -----------------------------------------------------------------------------
* @package     smartVISU
* @author      Wolfram v. HÃ¼lsen
* @copyright   2012 - 2024
* @license     GPL [http://www.gnu.de]
* @version     1.0
*
* @title       Plot Analyser
* @category    visu
* @icon        icons/ws/measure_power_meter.svg
* @color       #b00
* @description Analyse plots with flexible configuration of series parameters
*
* -----------------------------------------------------------------------------
*/


{% extends "apps.html" %}

{% block sidebar %}
	<div>
	<div class="app">
		<div class="image" style="background-color: #b00;"><img src="icons/ws/measure_power_meter.svg" alt="Plot Analyser"></div>
	</div>
	<h3 style="padding: 40px 0 8px 0;">Plot Analyser</h3>
	</div>
	<br />
	<div class="ui-field-contain">
		<label for="apItem">Item(s)</label>
		<input name="apItem" id="apItem"/>
	</div>
	<div class="ui-field-contain">
		<label for="apMode"> DB mode</label>
		<select name="apMode" id="apMode">
		</select>
	</div>
	<div class="ui-field-contain">
		<label for="apTmin">tmin</label>
		<input name="apTmin" id="apTmin"/>
	</div>
		<div class="ui-field-contain">
		<label for="apTmax">tmax</label>
		<input name="apTmax" id="apTmax"/>
	</div>
	<div class="ui-field-contain">
		<label for="apCount">Count(s)</label>
		<input name="apCount" id="apCount"/>
	</div>
	<div class="ui-field-contain">
		<label for="apExposure">Series type(s)</label>
		<input name="apExposure" id="apExposure"/>
	</div>
	<div class="ui-field-contain">
		<label for="apColor">Color(s)</label>
		<input name="apColor" id="apColor"/>
	</div>

	<br>
	<button id="apSubmit">Start Plot</button>
	
{% endblock %}


{% block content %}
	
	/** 
	***********************************************************
	menu for display in primary block on smartphones
    (doesn't really make sense for plot analysis)
	<div class="visible-phone">
		<div class="ui-field-contain">
			<label for="tkFuel1">Kraftstoffsorte</label>
				<select name="tkFuel1" id="tkFuel1">
					<option value="Diesel" selected="selected">Diesel</option>
					<option value="E10">Super E10 </option>
					<option value="E5"> Super E5 </option>
			</select>
		</div>
		<div class="ui-field-contain">
			<label for="apMode1">mode</label>
			<select name="apMode1" id="apMode1">
			</select>
		</div>
	</div>
	<h3>Plot Analysis</h3>
	Stand:&nbsp;<span id="tkStand"></span>
	<br /><br />
	***********************************************************
	*/
	
	
	<style type="text/css">

		.apdisplay .highcharts-root:not(.supersized) {
			max-height: 800px;
		}
		.apdisplay .plot.plot-highstock {
			height: 500px;
		}
		
	</style>
	
   {% set mode = "raw" %} /** just init to activate boost mode */
   {% set zoom = "advanced" %}
   {% set export = 2 %} /** activate export menu */

	<div id="analyse-plots" data-widget="app.analyse_plots" class="apdisplay">
	
		{{ plot.period('analyse-plotpopup', item, mode, tmin, tmax, ymin, ymax, count, label, color, exposure, axis, zoom, assign, opposite, ycolor, ytype, unit, chartoptions, stacking, stacks, export, source) }}
	</div>

/**	data-mode="{{ implode(mode) }}"
	data-item="{{ implode(seriesitems) }}"
	data-ymin="{{ implode(ymin) }}" 
	data-ymax="{{ implode(ymax) }}"
	data-tmin="{{ tmin }}" 
	data-tmax="{{ tmax }}"
	data-label="{{ implode(label) }}" 
	data-color="{{ implode(color) }}" 
	data-exposure="{{ implode(exposure) }}" 
	data-axis="{{ implode(axis) }}"
	data-zoom="{{ zoom }}"
	data-assign="{{ implode(assign) }}"
	data-opposite="{{ implode(opposite) }}"
	data-ycolor="{{ implode(ycolor) }}"
	data-stacks="{{ implode(stacks) }}" 
	data-ytype="{{ implode(ytype) }}" 
	data-unit="{{ implode(units) }}" 
	data-stacking="{{ implode(stacking) }}" 
	data-chart-options="{{ chartoptions|json_encode()|escape('html_attr') }}" 
	data-exportmenu="{{ export|default(0) }}"
*/


	<script type="text/javascript">
		$('#{{ page }}').on('pagecreate', function (event, ui) {
			// source was for different menu styles and is not needed any more
			// can be used to display config menus for more items
			var source = "";
			
			// get available database modes from backend driver and make
			// them selectable options
			var modes = io.aggregates ? io.aggregates.concat(['minmax', 'minmaxavg']) : ['avg', 'min', 'max', 'diff', 'sum', 'on', 'raw', 'count', 'countall', 'integrate', 'differentiate', 'duration', 'minmax', 'minmaxavg'];
			var modeslist = ""
			$.each(modes, function(idx, mode){
				modeslist += "<option value=\"" + mode + "\">" +  mode  + "</option>";
			})
			$('#apMode'+source).append(modeslist).val('avg').selectmenu('refresh');
			
			// start plot display on button click
			$('#apSubmit ').on('click', function(event,ui){
			
				var plot = $('[id*="analyse-plotpopup"]');
				var plotId = plot.attr('id');
				var that = plot.data().svWidget;
								
				// stop subscription for actual plot
				if (io.stopseries )
					io.stopseries(plot);
				that.element.highcharts().destroy();
				var apSeries = "";
					
				//we could loop here using source for addition item configurations
				// populate widget parameters from input elements
				var apItems = $('#apItem'+ source).val().toString().split(/,\s*/);
				var apMode = $('#apMode' + source).val().toString();
				var apTmin = $('#apTmin' + source).val().toString() || '1h';
				var apTmax = $('#apTmax' + source).val().toString() || 'now';
				var apCounts = $('#apCount' + source).val().toString().split(/,\s*/);
				var apCount = "";
				var apExposures = $('#apExposure' + source).val().toString().split(/,\s*/);
				var apExposure = "";
				var apColors = $('#apColor' + source).val().toString().split(/,\s*/);
				var apColor = "";

				$.each(apItems, function(idx, apItem){
					var delimiter = idx > 0 ? ',': '';
					if (apSeries != "")
						apSeries += ',';
					if (apCounts[idx] == undefined)
						apCounts.push(apCounts[idx-1] || 100);
					if (apExposures[idx] == undefined)
						apExposures.push(apExposures[idx-1]);
					if (!apColors[0] == undefined && apColors[idx] == undefined)
						apExposures.push(apColors[idx-1] || 'line');
					if (apMode.indexOf("minmax") == 0){
						apSeries += [apItem, "min", apTmin, apTmax, apCounts[idx]].join('.') +',';
						apSeries += [apItem, "max", apTmin, apTmax, apCounts[idx]].join('.');
						if (apMode == "minmaxavg")
							apSeries += ',' + [apItem, "avg", apTmin, apTmax, apCounts[idx]].join('.');
					} else
							apSeries += [apItem, apMode, apTmin, apTmax, apCounts[idx]].join('.');
					apCount += delimiter + apCounts[idx];
					apExposure += delimiter + apExposures[idx];
					apColor += delimiter + apColors[idx];
					if (idx >0){
						apMode += ',' + apMode;
					}
				})
				plot.attr('data-item',  apSeries);
				that.options.item = apSeries;
				that.items = apSeries.split(',');
				plot.attr('data-mode',  apMode);
				that.options.mode = apMode;
				plot.attr('data-tmin', apTmin);
				that.options.tmin = apTmin;
				plot.attr('data-tmax', apTmax);
				that.options.tmax = apTmax;
				plot.attr('data-count', apCount);
				that.options.count = apCount;
				plot.attr('data-exposure', apExposure);
				that.options.exposure = apExposure;
				plot.attr('data-color', apColor);
				that.options.color = apColor;
				
				that._create()
								
				// start new series subscription
				if (io.startseries)
					io.startseries(plot);
			})
		});

	</script>

	<hr />
{% endblock %}
